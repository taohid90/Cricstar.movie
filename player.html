<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>Playing - CrickStar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
    <style>
        /* প্রধান ফন্ট এবং বেসিক স্টাইল */
        @import url('https://fonts.googleapis.com/css2?family=Baloo+2&display=swap');
        body { font-family: 'Baloo 2', cursive; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ভিডিও প্লেয়ার কন্টেইনার */
        .player-wrapper {
             position: relative; width: 100%; padding-top: 56.25%; background-color: #000;
        }
        .player-wrapper iframe, .player-wrapper video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;
        }
        .player-wrapper video { object-fit: cover; }

        /* অ্যাকশন বাটনের জন্য স্টাইল */
        .action-btn {
            transition: all 0.2s ease-in-out;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            color: #1DB954; /* Spotify Green for hover */
        }
        .action-btn.active {
            color: #1DB954; /* অ্যাক্টিভ বাটনের জন্য সবুজ রঙ */
        }

        /* কমেন্ট সেকশনের জন্য স্টাইল */
        #comment-section {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60%; /* স্ক্রিনের ৬০% জায়গা নেবে */
            background-color: #121212;
            border-top: 1px solid #282828;
            transform: translateY(100%); /* ডিফল্টভাবে নিচে লুকানো থাকবে */
            transition: transform 0.4s ease-in-out;
            z-index: 50;
        }
        #comment-section.open {
            transform: translateY(0); /* .open ক্লাস যোগ হলে উপরে উঠে আসবে */
        }

        /* সম্পর্কিত মুভির পোস্টারে হোভার ইফেক্ট */
        .related-movie-card img { transition: transform 0.3s ease-in-out; }
        .related-movie-card:hover img { transform: scale(1.05); }
    </style>
</head>
<body class="bg-black text-white">

    <main class="w-full pb-40"> <!-- কমেন্ট সেকশনের জন্য নিচে জায়গা রাখা হলো -->
        <!-- ভিডিও প্লেয়ার সেকশন -->
        <section id="player-container" class="w-full bg-black">
            <div class="player-wrapper flex items-center justify-center">
                <i class="fas fa-spinner fa-spin text-4xl text-gray-500"></i>
            </div>
        </section>

        <!-- নতুন: লাইক, কমেন্ট, রিপোর্ট সেকশন -->
        <section id="action-bar" class="p-4 md:px-6 flex items-center justify-between text-gray-400 border-b border-gray-800">
            <div class="flex space-x-6">
                <button id="like-btn" class="action-btn flex items-center space-x-2">
                    <i class="far fa-thumbs-up text-xl"></i>
                    <span id="like-count">0</span>
                </button>
                <button id="dislike-btn" class="action-btn flex items-center space-x-2">
                    <i class="far fa-thumbs-down text-xl"></i>
                    <span id="dislike-count">0</span>
                </button>
                <button id="comment-btn" class="action-btn flex items-center space-x-2">
                    <i class="far fa-comment-alt text-xl"></i>
                    <span>Comment</span>
                </button>
            </div>
            <button id="report-btn" class="action-btn flex items-center space-x-2">
                <i class="far fa-flag text-xl"></i>
                <span>Report</span>
            </button>
        </section>

        <!-- সিনেমার তথ্য সেকশন -->
        <section id="movie-info" class="p-4 md:p-6"></section>

        <!-- সম্পর্কিত সিনেমা সেকশন -->
        <section id="related-movies" class="p-4 md:p-6">
             <h3 class="text-white text-lg font-semibold mb-3">Related Movies</h3>
             <div id="related-movies-container" class="flex space-x-3 overflow-x-auto scrollbar-hide pb-2"></div>
        </section>
    </main>

    <!-- নতুন: কমেন্ট বক্স (ডিফল্টভাবে লুকানো) -->
    <section id="comment-section" class="flex flex-col">
        <header class="p-4 border-b border-gray-700 flex justify-between items-center">
            <h3 class="text-lg font-semibold">Comments</h3>
            <button id="close-comments-btn" class="text-2xl">×</button>
        </header>
        <div id="comments-list" class="flex-grow p-4 overflow-y-auto">
            <!-- কমেন্টগুলো এখানে জাভাস্ক্রিপ্ট দিয়ে যোগ করা হবে -->
        </div>
        <form id="comment-form" class="p-4 border-t border-gray-700 flex items-center">
            <input id="comment-input" type="text" class="w-full bg-gray-800 text-white rounded-l-md p-2 focus:outline-none" placeholder="Add a comment...">
            <button type="submit" class="bg-green-600 text-white p-2 rounded-r-md hover:bg-green-700">Send</button>
        </form>
    </section>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, collection, query, orderBy, addDoc, serverTimestamp, updateDoc, increment } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        
        const firebaseConfig = {
  apiKey: "AIzaSyAb8YsPMOY53GxiycCL6G0MPZdgWe3nnyY",
  authDomain: "movie-92659.firebaseapp.com",
  databaseURL: "https://movie-92659-default-rtdb.firebaseio.com",
  projectId: "movie-92659",
  storageBucket: "movie-92659.firebasestorage.app",
  messagingSenderId: "1090734362509",
  appId: "1:1090734362509:web:86be5583f6e8fcfdfa77c4",
  measurementId: "G-XF1TEP0DSJ"
};
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const playerContainer = document.getElementById('player-container');
        const movieInfoContainer = document.getElementById('movie-info');
        const relatedMoviesContainer = document.getElementById('related-movies-container');
        
        // নতুন এলিমেন্টগুলো সিলেক্ট করা
        const likeBtn = document.getElementById('like-btn');
        const dislikeBtn = document.getElementById('dislike-btn');
        const commentBtn = document.getElementById('comment-btn');
        const reportBtn = document.getElementById('report-btn');
        const likeCountSpan = document.getElementById('like-count');
        const dislikeCountSpan = document.getElementById('dislike-count');
        const commentSection = document.getElementById('comment-section');
        const closeCommentsBtn = document.getElementById('close-comments-btn');
        const commentForm = document.getElementById('comment-form');
        const commentInput = document.getElementById('comment-input');
        const commentsList = document.getElementById('comments-list');

        let movieRef; // movieRef কে গ্লোবালি ডিক্লেয়ার করা হলো

        /** চূড়ান্ত প্লেয়ার তৈরি করে */
        function createFinalPlayer(videoUrl, posterUrl) { /* আগের কোডের মতোই */ }
        
        /** সিনেমার ডেটা লোড করে এবং UI আপডেট করে */
        async function loadMovieData() {
            const urlParams = new URLSearchParams(window.location.search);
            const fullId = urlParams.get('id');
            if (!fullId || !fullId.includes('/')) { /* এরর হ্যান্ডেলিং */ return; }

            const [categoryId, movieId] = fullId.split('/');
            movieRef = doc(db, `categories/${categoryId}/movies`, movieId);
            
            // রিয়েল-টাইম আপডেটের জন্য onSnapshot ব্যবহার করা
            onSnapshot(movieRef, (docSnap) => {
                if (!docSnap.exists()) { console.error("Movie not found"); return; }

                const movie = docSnap.data();
                if (!playerContainer.hasChildNodes() || playerContainer.innerText.includes("Loading")) {
                     createFinalPlayer(movie.videoUrl, movie.posterUrl);
                }
                document.title = `Playing ${movie.title} - CrickStar`;
                movieInfoContainer.innerHTML = `<h1 class="text-3xl md:text-4xl font-bold mb-2">${movie.title}</h1><p class="text-gray-300 max-w-3xl">${movie.description || 'No description available.'}</p>`;
                
                // লাইক ও ডিসলাইক সংখ্যা আপডেট করা
                likeCountSpan.textContent = movie.likes || 0;
                dislikeCountSpan.textContent = movie.dislikes || 0;

                updateActionButtonsUI(movieId);
            });

            // সম্পর্কিত সিনেমা লোড করা (এটি একবারই লোড হবে)
            loadRelatedMovies(categoryId, movieId);
            // ইন্টারেক্টিভ ফিচারগুলো সেটআপ করা
            setupActionHandlers(movieId);
            setupCommentSection(movieId);
        }

        /** লাইক, ডিসলাইক, কমেন্ট ও রিপোর্ট বাটনের জন্য ইভেন্ট হ্যান্ডেলার সেটআপ করে */
        function setupActionHandlers(movieId) {
            const storageKey = `crickstar_action_${movieId}`;

            likeBtn.onclick = () => handleVote('likes', movieId, storageKey);
            dislikeBtn.onclick = () => handleVote('dislikes', movieId, storageKey);
            
            reportBtn.onclick = () => {
                if (confirm("Are you sure you want to report this movie?")) {
                    updateDoc(movieRef, { reports: increment(1) });
                    alert("Thank you for your report.");
                }
            };
        }

        /** ভোট দেওয়ার লজিক (লাইক/ডিসলাইক) */
        async function handleVote(voteType, movieId, storageKey) {
            const currentVote = localStorage.getItem(storageKey);
            const oppositeVote = voteType === 'likes' ? 'dislikes' : 'likes';
            
            if (currentVote === voteType) { // যদি একই বাটনে আবার ক্লিক করে
                await updateDoc(movieRef, { [voteType]: increment(-1) });
                localStorage.removeItem(storageKey);
            } else {
                let updates = { [voteType]: increment(1) };
                if (currentVote) { // যদি ভোট পরিবর্তন করে
                    updates[oppositeVote] = increment(-1);
                }
                await updateDoc(movieRef, updates);
                localStorage.setItem(storageKey, voteType);
            }
        }

        /** ব্যবহারকারীর আগের ভোটের উপর ভিত্তি করে UI আপডেট করে */
        function updateActionButtonsUI(movieId) {
            const currentVote = localStorage.getItem(`crickstar_action_${movieId}`);
            likeBtn.classList.toggle('active', currentVote === 'likes');
            dislikeBtn.classList.toggle('active', currentVote === 'dislikes');
        }

        /** কমেন্ট সেকশন চালু ও বন্ধ এবং কমেন্ট পোস্ট করার লজিক */
        function setupCommentSection(movieId) {
            commentBtn.onclick = () => commentSection.classList.add('open');
            closeCommentsBtn.onclick = () => commentSection.classList.remove('open');
            
            // কমেন্ট পোস্ট করার জন্য
            commentForm.onsubmit = async (e) => {
                e.preventDefault();
                const text = commentInput.value.trim();
                if (text) {
                    const commentsCollectionRef = collection(db, `categories/${movieId.split('/')[0]}/movies/${movieId.split('/')[1]}/comments`);
                    await addDoc(commentsCollectionRef, {
                        text: text,
                        author: "Anonymous User", // আপনি চাইলে এখানে ইউজারনেম ব্যবহার করতে পারেন
                        createdAt: serverTimestamp()
                    });
                    commentInput.value = '';
                }
            };
            
            // কমেন্টগুলো রিয়েল-টাইমে শোনার জন্য
            listenForComments(movieId);
        }

        /** কমেন্টগুলো শোনে এবং UI-তে দেখায় */
        function listenForComments(movieId) {
            const commentsCollectionRef = collection(db, `categories/${movieId.split('/')[0]}/movies/${movieId.split('/')[1]}/comments`);
            const q = query(commentsCollectionRef, orderBy('createdAt', 'desc'));

            onSnapshot(q, (snapshot) => {
                commentsList.innerHTML = ''; // আগের কমেন্ট মুছে নতুন করে দেখানো
                if (snapshot.empty) {
                    commentsList.innerHTML = '<p class="text-gray-500 text-center">No comments yet. Be the first to comment!</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const comment = doc.data();
                    const date = comment.createdAt?.toDate().toLocaleString() || 'just now';
                    const commentEl = document.createElement('div');
                    commentEl.className = 'border-b border-gray-700 py-3';
                    commentEl.innerHTML = `
                        <div class="flex items-start space-x-3">
                            <i class="fas fa-user-circle text-2xl text-gray-400"></i>
                            <div>
                                <p class="font-semibold">${comment.author} <span class="text-xs text-gray-500 ml-2">${date}</span></p>
                                <p class="text-gray-300">${comment.text}</p>
                            </div>
                        </div>
                    `;
                    commentsList.appendChild(commentEl);
                });
            });
        }
        
        // আগের ফাংশনগুলো এখানে থাকবে
        function loadRelatedMovies(categoryId, currentMovieId) { /* আগের মতোই */ }

        // পৃষ্ঠা লোড হলে প্রধান ফাংশন চালু করা
        loadMovieData();

    </script>
</body>
</html>
